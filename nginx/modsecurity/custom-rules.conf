# Custom ModSecurity Rules for Japan Travel Budget Calculator
# OWASP CRS Customizations and Allowlists

# =====================================================
# RULE ENGINE ENFORCEMENT
# Ensure WAF is in blocking mode (not detection-only)
# =====================================================
SecRuleEngine On

# =====================================================
# PARANOIA LEVEL CONFIGURATION
# Level 2 provides good security without too many false positives
# =====================================================
SecAction \
    "id:900000,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    setvar:tx.blocking_paranoia_level=2,\
    setvar:tx.detection_paranoia_level=2"

# =====================================================
# ANOMALY SCORING THRESHOLDS
# Lower values = stricter blocking
# =====================================================
SecAction \
    "id:900110,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    setvar:tx.inbound_anomaly_score_threshold=5,\
    setvar:tx.outbound_anomaly_score_threshold=4"

# =====================================================
# ALLOWED HTTP METHODS
# Restrict to necessary methods only
# =====================================================
SecAction \
    "id:900200,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    setvar:'tx.allowed_methods=GET HEAD POST PUT DELETE OPTIONS'"

# =====================================================
# ALLOWED CONTENT TYPES
# =====================================================
SecAction \
    "id:900220,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    setvar:'tx.allowed_request_content_type=|application/x-www-form-urlencoded| |multipart/form-data| |text/xml| |application/xml| |application/json| |text/plain|'"

# =====================================================
# REQUEST SIZE LIMITS
# Protect against large payload attacks
# =====================================================
SecAction \
    "id:900300,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    setvar:tx.max_num_args=255,\
    setvar:tx.arg_name_length=100,\
    setvar:tx.arg_length=400,\
    setvar:tx.total_arg_length=64000,\
    setvar:tx.max_file_size=10485760,\
    setvar:tx.combined_file_sizes=10485760"

# =====================================================
# HEALTH CHECK ENDPOINT ALLOWLIST
# Bypass WAF for health probes
# =====================================================
SecRule REQUEST_URI "@beginsWith /health" \
    "id:1000001,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleEngine=Off"

SecRule REQUEST_URI "@beginsWith /api/health" \
    "id:1000002,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleEngine=Off"

# =====================================================
# STATIC ASSETS ALLOWLIST
# Bypass WAF for static files (performance optimization)
# =====================================================
SecRule REQUEST_URI "@rx \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$" \
    "id:1000010,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    ctl:ruleEngine=Off"

# =====================================================
# RATE LIMITING
# Block IPs making too many requests
# =====================================================
SecAction \
    "id:1000100,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    initcol:ip=%{REMOTE_ADDR}"

SecRule IP:REQUEST_COUNTER "@gt 100" \
    "id:1000101,\
    phase:1,\
    deny,\
    status:429,\
    log,\
    msg:'Rate limit exceeded - too many requests from IP',\
    tag:'rate-limit'"

SecRule REQUEST_URI "!@beginsWith /api/health" \
    "id:1000102,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    setvar:ip.request_counter=+1,\
    expirevar:ip.request_counter=60"

# =====================================================
# BOT AND SCANNER DETECTION
# Block known malicious user agents
# =====================================================
SecRule REQUEST_HEADERS:User-Agent "@pmFromFile /etc/nginx/modsecurity/rules/scanners-user-agents.data" \
    "id:1000200,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'Known malicious scanner detected',\
    tag:'scanner-detection'"

# =====================================================
# PATH TRAVERSAL PROTECTION (Enhanced)
# =====================================================
SecRule REQUEST_URI|ARGS|ARGS_NAMES "@contains ../" \
    "id:1000300,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Path traversal attempt detected',\
    tag:'path-traversal'"

SecRule REQUEST_URI|ARGS|ARGS_NAMES "@contains ..%2f" \
    "id:1000301,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Encoded path traversal attempt detected',\
    tag:'path-traversal'"

# =====================================================
# COMMAND INJECTION PROTECTION (Enhanced)
# =====================================================
SecRule ARGS|ARGS_NAMES|REQUEST_BODY "@rx (?:;|\||`|\\$\\(|\\$\\{)" \
    "id:1000400,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Command injection attempt detected',\
    tag:'command-injection'"

# =====================================================
# JAVA/LOG4J PROTECTION
# Block Log4Shell and JNDI injection
# =====================================================
SecRule REQUEST_URI|ARGS|ARGS_NAMES|REQUEST_HEADERS "@rx (?i)\\$\\{jndi:" \
    "id:1000500,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'JNDI injection attempt (Log4Shell)',\
    tag:'log4shell'"

# =====================================================
# SSRF PROTECTION
# Block server-side request forgery attempts
# =====================================================
SecRule ARGS|ARGS_NAMES "@rx (?:169\\.254\\.|127\\.0\\.0\\.1|localhost|0\\.0\\.0\\.0|\\[::1\\])" \
    "id:1000600,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'SSRF attempt detected - internal IP reference',\
    tag:'ssrf'"

# =====================================================
# PROTOCOL SMUGGLING PROTECTION
# =====================================================
SecRule REQUEST_HEADERS:Transfer-Encoding "@rx chunked.*chunked" \
    "id:1000700,\
    phase:1,\
    deny,\
    status:400,\
    log,\
    msg:'HTTP request smuggling attempt - duplicate Transfer-Encoding',\
    tag:'request-smuggling'"

SecRule REQUEST_HEADERS:Content-Length "@rx ^[0-9]+,[0-9]+" \
    "id:1000701,\
    phase:1,\
    deny,\
    status:400,\
    log,\
    msg:'HTTP request smuggling attempt - multiple Content-Length',\
    tag:'request-smuggling'"

# =====================================================
# UPLOAD RESTRICTIONS
# Block dangerous file uploads
# =====================================================
SecRule FILES_NAMES "@rx (?i)\\.(php|phtml|php3|php4|php5|phps|phar|exe|bat|cmd|sh|bash|ps1|jar|jsp|asp|aspx|cgi|pl|py|rb)$" \
    "id:1000800,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'Dangerous file upload blocked',\
    tag:'file-upload'"

# =====================================================
# XML EXTERNAL ENTITY (XXE) PROTECTION
# =====================================================
SecRule REQUEST_BODY "@rx (?i)<!ENTITY" \
    "id:1000900,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'XXE attack attempt detected',\
    tag:'xxe'"

SecRule REQUEST_BODY "@rx (?i)SYSTEM\\s+[\"'][^\"']*[\"']" \
    "id:1000901,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'XXE SYSTEM entity detected',\
    tag:'xxe'"

# =====================================================
# SENSITIVE DATA LEAKAGE PREVENTION
# Block responses containing sensitive patterns
# =====================================================
SecRule RESPONSE_BODY "@rx (?:password|api_key|secret_key|private_key|access_token)\\s*[=:]\\s*['\"][^'\"]{8,}['\"]" \
    "id:1001000,\
    phase:4,\
    deny,\
    status:500,\
    log,\
    msg:'Potential sensitive data leakage in response',\
    tag:'data-leakage'"

# =====================================================
# CSRF TOKEN ENFORCEMENT FOR STATE-CHANGING REQUESTS
# =====================================================
SecRule REQUEST_METHOD "@pm POST PUT DELETE PATCH" \
    "id:1001100,\
    phase:2,\
    pass,\
    t:none,\
    nolog,\
    chain"
    SecRule REQUEST_URI "!@beginsWith /api/" \
        "chain"
        SecRule &REQUEST_HEADERS:X-CSRF-Token "@eq 0" \
            "deny,\
            status:403,\
            log,\
            msg:'Missing CSRF token for state-changing request',\
            tag:'csrf'"

# =====================================================
# GEO-BLOCKING EXCEPTIONS
# Allow traffic from expected regions (Singapore focus)
# This is a placeholder - requires GeoIP database
# =====================================================
# SecGeoLookupDB /etc/nginx/modsecurity/GeoLite2-Country.mmdb
# SecRule GEO:COUNTRY_CODE "!@pm SG JP US GB AU" \
#     "id:1001200,\
#     phase:1,\
#     log,\
#     msg:'Request from unexpected country: %{GEO.COUNTRY_CODE}',\
#     tag:'geo-filter'"

# =====================================================
# API-SPECIFIC PROTECTIONS
# =====================================================

# Protect chat endpoint from abuse
SecRule REQUEST_URI "@beginsWith /api/chat" \
    "id:1001300,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    setvar:tx.inbound_anomaly_score_threshold=3"

# Enforce JSON content type for API endpoints
SecRule REQUEST_URI "@beginsWith /api/" \
    "id:1001301,\
    phase:1,\
    pass,\
    t:none,\
    nolog,\
    chain"
    SecRule REQUEST_METHOD "@pm POST PUT PATCH" \
        "chain"
        SecRule REQUEST_HEADERS:Content-Type "!@contains application/json" \
            "deny,\
            status:415,\
            log,\
            msg:'API requires JSON content type',\
            tag:'content-type'"

# =====================================================
# LOGGING OPTIMIZATION
# Reduce log volume for allowed traffic
# =====================================================
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABCFHZ
SecAuditLogType Serial
SecAuditLog /var/log/modsecurity/audit.log
